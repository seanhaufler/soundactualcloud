<html>
<head>
<title>SoundActualCloud</title>

<link rel="stylesheet" href="http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" type="text/css" media="all" />
<link rel="stylesheet" href="/static/css/bootstrap.css" type="text/css" media="all" />
<style>
    #main {
        padding-top: 50px;
    }
    .node {
          stroke: #fff;
          stroke-width: 1.5px;
    }

    .selected {
          stroke: red !important;
    }

    .link {
          stroke: #AAA;
            stroke-opacity: .6;
    }
</style>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"> </script> 
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
<script src="/static/js/bootstrap.js" type="text/javascript"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>

</head>
<body>
    <div id="main" class="container-fluid">
      <div class="row-fluid">
        <div class="span3">
          <div class="well sidebar-nav">
            <h3>SOUND (ACTUAL?) CLOUD MAP</h3>
            <hr>
            <div id="artist-info">
              <h5>Artist Info</h5>
              <h4 class="name">{{ artist }}</h4>
                <div id="gsWidget">
                    <p>
                        <object width="150" height="40"> 
                            <param name="movie" value="http://grooveshark.com/songWidget.swf">
                            <param name="wmode" value="window"> 
                            <param name="allowScriptAccess" value="always"> 
                            <param class="gs" name="flashvars" value="hostname=grooveshark.com&amp;songID=25240976&amp;style=metal&amp;p=0"> 
                            <embed src="http://grooveshark.com/songWidget.swf" type="application/x-shockwave-flash" width="150" height="40"  allowscriptaccess="always" wmode="window">
                        </object>
                    </p>
                </div>
              <img style="display:none;" src="/a.png"/>
              <p class="desc"></p>
              <p class="song"></p>
              <p class="song_id"></p>
              <p class="pop"></p>
              <p class="fb"></p>
            </div><!-- artist-info -->
          </div><!--/.well -->
        </div><!--/span-->
        <div class="span9">
          <div id="hero" class="hero-unit">

          </div>
          </div><!--/row-->
        </div><!--/span-->
      </div><!--/row-->
      <hr>
      <footer>
        <p>&copy; Sound(Actual?)Cloud 2013</p>
      </footer>

    </div><!--/.fluid-container-->

</body>
<script>

var width = 960,
height = 600,
artist = "{{ artist }}";
init(artist);


function init(artist) {
    var color = d3.scale.category20();

    var force = d3.layout.force()
    .charge(-400)
    .linkDistance(200)
    .size([width, height]);

    var svg = d3.select("#hero").append("svg")
    .attr("width", width)
    .attr("height", height);

    // "/static/miserables.json"
    d3.json("/related?artist="+encodeURIComponent(artist), function(error, res) {

        // convert the api return to the miserables json format
        var graph = { nodes : [], links : [] };

        // Push center node
        graph.nodes.push({
                'name' : res.name,
                'img' : res.song_cover,
                'song_id' : res.song_id,
                'song' : res.song,
                'fb_page' : res.fb_page,
                'pop' : res.pop,
                'song_pop' : res.song_pop,
                'desc' : res.desc,
                'group' : 30
        });

        if (res.peers == undefined) {
            console.log('error: no peers');
            console.log(res);
            return;
        }

        console.log(res.peers);
        var iter = 1; // iterator
        $.each(res.peers, function(key, obj) {
            console.log('ech peer');
            console.log(key);
            console.log(obj);
            graph.nodes.push({
                'name' : key,
                'img' : obj.song_cover,
                'song_id' : obj.song_id,
                'song' : obj.song,
                'fb_page' : obj.fb_page,
                'pop' : obj.pop,
                'song_pop' : obj.song_pop,
                'desc' : obj.desc,
                'group' : Math.floor((Math.random()*15)+5)
            });
            if (Math.random() > .4) {
                graph.links.push({
                    'target' : 0,
                    'source' : iter,
                    'value' : Math.floor((Math.random()*10)+1)
                });
            }
            iter += 1;
        });

        for (var i = 0; i < Math.floor(iter / 2); i++) {
            // create a bunch of random links
            graph.links.push({
                'target' : Math.floor((Math.random()*(iter-1))+1),
                'source' : Math.floor((Math.random()*(iter-1))+1),
                'value' : Math.floor((Math.random()*10)+1)
            });
        }

        console.log('Checking Graph');
        console.log(graph);

        force.nodes(graph.nodes)
        .links(graph.links)
        .start();

        var link = svg.selectAll("line.link")
        .data(graph.links)
        .enter().append("line")
        .attr("class", "link")
        .style("stroke-width", function(d) { return Math.sqrt(d.value); });

        var node = svg.selectAll("circle.node")
        .data(graph.nodes)
        .enter().append("circle")
        .attr("class", "node")
        .attr("r", function(d) { return (d.group+2) * 2; })
        .attr("img", function(d) { return d.img; })
        .attr("desc", function(d) { return d.desc; })
        .attr("song_id", function(d) { return d.song_id; })
        .attr("song", function(d) { return d.song; })
        .attr("fb_page", function(d) { return d.fb_page; })
        .attr("pop", function(d) { return d.pop; })
        .attr("song_pop", function(d) { return d.song_pop; })
        .attr("img", function(d) { return d.img; })
        .style("fill", function(d) { return color(d.group); })
        .call(force.drag);

        node.append("title")
        .text(function(d) { return d.name; });

        force.on("tick", function() {
            link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

            node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });
        });
    });
}


var $info = $('#artist-info');

$('.node').live('mouseover mouseout click', function(event) {
  if (event.type == 'mouseover') {

    var $title = $(this).find('title').text();
    var $desc = $(this).attr('desc');
    var $song = $(this).attr('song');
    var $id = $(this).attr('song_id');
    var $pop = $(this).attr('pop');
    var $fb = $(this).attr('fb');
    var $img = $(this).attr('img');

    buildGS($id);

    // hacky way to populate view.. too lazy to use template
    $info.find('.name').empty().append($title);
    $info.find('.desc').empty().append($desc);
    $info.find('.song').empty().append($song);
    $info.find('.pop').empty().append($pop);
    $info.find('.fb').empty().append($fb);
    $info.find('img').attr('src', $img).show();

    // make color lighter
    var color = $(this).attr('style').match(/[0-9a-f]{6}/)[0];
    var lighter = LightenDarkenColor(color, 30);
    $(this).attr('style', 'fill: '+lighter)
           .attr('color', 'fill: #'+color);
  } else if (event.type == 'mouseout') {
    // make color lighter;
    var color = $(this).attr('color');
    $(this).attr('style', color);

    console.log($(this));
    console.log(color);
  } else {
       console.log('click');
       console.log(this);
       var $title = $(this).find('title').text();
       console.log($title);
       if ($title === artist) {
           return;
       } else {
            $('#hero').empty();
           init($title);
           return;
       }
       $('.node').attr('class', 'node');
       $(this).attr('class', 'node selected');   
  }
});

function buildGS(songId) {
    console.log('changing gs to ' + songId);
    var obj = '<p><object width="150" height="40"><param name="movie" value="http://grooveshark.com/songWidget.swf"><param name="wmode" value="window"><param name="allowScriptAccess" value="always"><param class="gs" name="flashvars" value="hostname=grooveshark.com&amp;songID='+songId+'&amp;style=metal&amp;p=0"><embed src="http://grooveshark.com/songWidget.swf" type="application/x-shockwave-flash" width="150" height="40"  allowscriptaccess="always" wmode="window"></object></p>'
     $('#gsWidget').empty().append(obj);

}

function LightenDarkenColor(col,amt) {
    var usePound = false;
    if ( col[0] == "#" ) {
        col = col.slice(1);
        usePound = true;
    }
    var num = parseInt(col,16);
    var r = (num >> 16) + amt;

    if ( r > 255 ) r = 255;
    else if  (r < 0) r = 0;

    var b = ((num >> 8) & 0x00FF) + amt;

    if ( b > 255 ) b = 255;
    else if  (b < 0) b = 0;

    var g = (num & 0x0000FF) + amt;

    if ( g > 255 ) g = 255;
    else if  ( g < 0 ) g = 0;

    return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
}
</script>
</html>
